#!/bin/sh

. `dirname $0`/xtools.sh

check_llvm_prefix
check_tool ${LLVM_PREFIX} CC clang
check_tool ${LLVM_PREFIX} CXX clang++
check_tool ${LLVM_PREFIX} LLC llc
check_tool ${LLVM_PREFIX} LLVM_LINK llvm-link
check_tool ${LLVM_PREFIX} OPT opt

find_llvm_prov_libraries

export LLVM_INSTR_FLAGS="-load ${LLVM_PROV_LIB} -load ${LOOM_LIB} -prov ${LLVM_INSTR_FLAGS}"

# If building on FreeBSD 10, /usr/bin/ld doesn't support the
# --no-fatal-warnings option, so we need to suppress its use.
if [ `uname -U` -lt 1100000 ]
then
	export LD_NO_FATAL_WARNS=
fi


# Disable -Werror in both buildworld (NO_WERROR) and buildkernel (WERROR).
# This is currently necessary due to warnings generated by development
# versions of Clang (v3.9).
export NO_WERROR=
export WERROR=

# Enable instrumentation
export WITH_INSTRUMENT_BINARIES=yes

echo "------------------------------------------------------------------------"
echo "llvm-prov-make: Using LLVM tools found at:"
echo "------------------------------------------------------------------------"
echo "XCC:        ${XCC}"
echo "XCXX:       ${XCXX}"
echo "XLLC:       ${XLLC}"
echo "XLLVM_LINK: ${XLLVM_LINK}"
echo "XOPT:       ${XOPT}"
echo "------------------------------------------------------------------------"
echo "llvm-prov-make: Loom and llvm-prov arguments:"
echo "------------------------------------------------------------------------"
echo "LOOM_LIB:      ${LOOM_LIB}"
echo "LLVM_PROV_LIB: ${LLVM_PROV_LIB}"
echo "LLVM_INSTR_FLAGS: ${LLVM_INSTR_FLAGS}"
echo "------------------------------------------------------------------------"

make $*
